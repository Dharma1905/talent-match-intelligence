duckdb.sql("""
CREATE OR REPLACE TABLE tv_weights AS
SELECT 'QDD' AS tv, 0.1093 AS weight UNION ALL
SELECT 'SEA', 0.0354 UNION ALL
SELECT 'STO', 0.0325 UNION ALL
SELECT 'VCU', 0.0323 UNION ALL
SELECT 'IDS', 0.0314 UNION ALL
SELECT 'LIE', 0.0248 UNION ALL
SELECT 'CSI', 0.0233 UNION ALL
SELECT 'FTC', 0.0184 UNION ALL
SELECT 'GDR', 0.0163 UNION ALL
SELECT 'CEX', 0.0124;
""")
duckdb.sql("""
CREATE OR REPLACE TABLE tv_long AS
SELECT 
    employee_id,
    regexp_replace(col, 'pillar_', '') AS tv,
    CAST(value AS DOUBLE) AS score
FROM employee_features
UNPIVOT (value FOR col IN (
    pillar_QDD, pillar_SEA, pillar_STO, pillar_VCU, pillar_IDS,
    pillar_LIE, pillar_CSI, pillar_FTC, pillar_GDR, pillar_CEX
));
""")
duckdb.sql("""
CREATE OR REPLACE TABLE benchmark_ids AS
SELECT DISTINCT employee_id
FROM employee_features
WHERE rating = 5;
""")
duckdb.sql("""
CREATE OR REPLACE TABLE tv_baseline AS
SELECT 
    tv,
    MEDIAN(score) AS baseline_score
FROM tv_long
WHERE employee_id IN (SELECT employee_id FROM benchmark_ids)
GROUP BY tv;
""")
duckdb.sql("""
CREATE OR REPLACE TABLE tv_match AS
SELECT
    e.employee_id,
    e.tv,
    e.score AS user_score,
    b.baseline_score,
    ROUND((e.score / b.baseline_score) * 100, 1) AS tv_match_rate
FROM tv_long e
JOIN tv_baseline b USING(tv);
""")
duckdb.sql("""
CREATE OR REPLACE TABLE tgv_map AS
SELECT * FROM (
    VALUES
        ('QDD','Execution Excellence'),
        ('STO','Execution Excellence'),
        ('GDR','Execution Excellence'),
        ('CSI','Execution Excellence'),

        ('FTC','Strategic Capability'),
        ('IDS','Strategic Capability'),
        ('LIE','Strategic Capability'),
        ('CEX','Strategic Capability'),

        ('SEA','People & Culture Alignment'),
        ('VCU','People & Culture Alignment')
) AS t(tv, tgv);
""")
duckdb.sql("""
CREATE OR REPLACE TABLE tgv_match AS
SELECT
    m.employee_id,
    tm.tgv,
    SUM(m.tv_match_rate * w.weight) AS tgv_match_rate
FROM tv_match m
JOIN tv_weights w ON m.tv = w.tv
JOIN tgv_map tm ON m.tv = tm.tv
GROUP BY 1, 2;
""")
duckdb.sql("""
CREATE OR REPLACE TABLE final_match AS
SELECT
    employee_id,
    SUM(tgv_match_rate) AS final_match_rate
FROM tgv_match
GROUP BY employee_id;
""")
full_output = duckdb.sql("""
SELECT
    ef.employee_id,
    ef.directorate_id AS directorate,
    ef.position_id AS position,
    ef.grade_id AS grade,
    tm.tgv AS tgv_name,
    tm.tgv_match_rate,
    tvm.tv AS tv_name,
    tb.baseline_score,
    tvm.user_score,
    tvm.tv_match_rate,
    fm.final_match_rate
FROM employee_features ef
LEFT JOIN tgv_match tm ON ef.employee_id = tm.employee_id
LEFT JOIN tv_match tvm ON ef.employee_id = tvm.employee_id 
LEFT JOIN tv_baseline tb ON tvm.tv = tb.tv
LEFT JOIN final_match fm ON ef.employee_id = fm.employee_id
ORDER BY ef.employee_id, tgv_name, tv_name;
""").df()

full_output